<!DOCTYPE html>
<html>
  <head>
      <meta http-equiv="Content-type" content="text/html; charset=utf-8">
      <title>Falling Bananas</title>
      <script src="jquery-1.3.2.min.js"></script>
      <script src="draw-functions.js"></script>
      <script src="game-objects.js"></script>
      <script>
        
        $(function() {
        // http://paulirish.com/2011/requestanimationframe-for-smart-animating/
		// http://my.opera.com/emoller/blog/2011/12/20/requestanimationframe-for-smart-er-animating

		// requestAnimationFrame polyfill by Erik Mï¿½ller
		// fixes from Paul Irish and Tino Zijdel

		(function() {
			var lastTime = 0;
			var vendors = ['ms', 'moz', 'webkit', 'o'];
			for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
				window.requestAnimationFrame = window[vendors[x]+'RequestAnimationFrame'];
				window.cancelAnimationFrame = window[vendors[x]+'CancelAnimationFrame'] 
										   || window[vendors[x]+'CancelRequestAnimationFrame'];
			}
		 
			if (!window.requestAnimationFrame)
				window.requestAnimationFrame = function(callback, element) {
					var currTime = new Date().getTime();
					var timeToCall = Math.max(0, 16 - (currTime - lastTime));
					var id = window.setTimeout(function() { callback(currTime + timeToCall); }, 
					  timeToCall);
					lastTime = currTime + timeToCall;
					return id;
				};
		 
			if (!window.cancelAnimationFrame)
				window.cancelAnimationFrame = function(id) {
					clearTimeout(id);
				};
		}());
		
		//********************************************************
        
		var cvs = document.getElementById('canvas');
		var ctx = canvas.getContext('2d');
		
		var gWorld = new gameWorld(6);
		
		gWorld.w = cvs.width;
		gWorld.h = cvs.height;
		
		
		function startGame() {
		//init the game
		gWorld.addObject(makeGround(gWorld.w, gWorld.h));
		gWorld.addObject(makeCanopy(gWorld.w));
		gWorld.addObject(makePlayer());
		
		$(document).keydown(function(evt) {
				if (evt.keyCode == 39) {
					gWorld.keyPressed.right = true;
				} else if (evt.keyCode == 37){
					gWorld.keyPressed.left = true;
				}
			});       

			$(document).keyup(function(evt) {
				if (evt.keyCode == 39) {
					gWorld.keyPressed.right = false;
				} else if (evt.keyCode == 37){
					gWorld.keyPressed.left = false;
				}
			}); 
		}
		
		//main game loop
		gameLoop();
		
		
		
		var loop;
		var fps = 60;
		function gameLoop() {
			setTimeout(function() {
				loop = window.requestAnimationFrame(gameLoop);
				
				gWorld.updateGameObjects();
				gWorld.drawGame(ctx);
				gWorld.removeDeadObjects();
				gWorld.addNewObjects();
				
				
			}, 1000 / fps);
		}
		
		startGame();
        });
    </script>
  </head>
  <body>    
    <style type="text/css">
		body {
			margin: 0 auto;
			text-align: center;
		}
      canvas {
        border:1px solid black;
		background: #197329;
		margin: 30px auto;
      }
    </style>
    <canvas id="canvas" width="600" height="400"> 
      Your browser does not support the HTML5 Canvas feature. This game uses new HTML5 features and will only work on the latest versions of Firefox, Safari or Chrome (and maybe Internet Explorer 9).         
    </canvas>   
  </body>
</html>