<!DOCTYPE html>
<html>
  <head>
      <meta http-equiv="Content-type" content="text/html; charset=utf-8">
      <title>Falling Bananas</title>
      <script src="jquery-1.3.2.min.js"></script>
      <script src="draw-functions.js"></script>
      <script src="sounds.js"></script>
      <script src="ui.js"></script>
      <script src="game-objects.js"></script>
      <script>
        
        
        $(function() {
        
        //REQUEST ANIM FRAME---------------------------------
        // http://paulirish.com/2011/requestanimationframe-for-smart-animating/
		// http://my.opera.com/emoller/blog/2011/12/20/requestanimationframe-for-smart-er-animating
		// requestAnimationFrame polyfill by Erik Mï¿½ller
		// fixes from Paul Irish and Tino Zijdel
		(function() {
			var lastTime = 0;
			var vendors = ['ms', 'moz', 'webkit', 'o'];
			for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
				window.requestAnimationFrame = window[vendors[x]+'RequestAnimationFrame'];
				window.cancelAnimationFrame = window[vendors[x]+'CancelAnimationFrame'] 
										   || window[vendors[x]+'CancelRequestAnimationFrame'];
			}
		 
			if (!window.requestAnimationFrame)
				window.requestAnimationFrame = function(callback, element) {
					var currTime = new Date().getTime();
					var timeToCall = Math.max(0, 16 - (currTime - lastTime));
					var id = window.setTimeout(function() { callback(currTime + timeToCall); }, 
					  timeToCall);
					lastTime = currTime + timeToCall;
					return id;
				};
		 
			if (!window.cancelAnimationFrame)
				window.cancelAnimationFrame = function(id) {
					clearTimeout(id);
				};
		}());
		//--------------------------------------------
		
		//MOUSE POSITION------------------------------------------
		function getMousePos(canvas, evt){
			// get canvas position
			var obj = canvas;
			var top = 0;
			var left = 0;
			while (obj && obj.tagName != 'BODY') {
				top += obj.offsetTop;
				left += obj.offsetLeft;
				obj = obj.offsetParent;
			}
		 
			// return relative mouse position
			var mouseX = evt.clientX - left + window.pageXOffset;
			var mouseY = evt.clientY - top + window.pageYOffset;
			return {
				x: mouseX,
				y: mouseY
			}
		}
		//--------------------------------------------------------
		
		//HELPFUL DEFBUG GUY-------------------------------
        function displayTest(output){
			//Set the text font and color
			ctx.fillStyle = 'rgb(255,255,255)';
			ctx.font = "18px Helvetica, Ariel";

			ctx.fillText(output ,500,30);
		
		}
		//-------------------------------------------
		
		//INIT VARS---------------------------------
		//the canvas where everything goes
		var cvs = document.getElementById('canvas');
		var ctx = canvas.getContext('2d');
		
		//animation
		var loop;
		var fps = 60;
		
		//the game world that runs it all
		var gWorld = new gameWorld(6);
		gWorld.w = cvs.width;
		gWorld.h = cvs.height;
		
		//various UI buttons
		var startBox = new clickBox({
				x: 30,
				y: 60,
				w: 100,
				h: 60,
				active: true
			});
			
		//--------------------------------------------
		
		//HANDLING SOME CLICK AND KEY EVENTS----------
		cvs.addEventListener('mousedown', function(evt)
		{
			var mousePos = getMousePos(cvs, evt);

			if (startBox.testClick(mousePos.x, mousePos.y)) {
				startBox.active = false;
				startGame();
			}
		});
		
		window.addEventListener('keydown', function(e) {
			if (e.keyCode === 13) {
				if (gWorld.state === 'MAIN') {
					startGame();
				}
			}
			
			if (e.keyCode === 80) {
				if (gWorld.state === 'RUNNING') {
					gWorld.state = 'PAUSE';
				} else if (gWorld.state === 'PAUSE') {
					gWorld.state = 'RUNNING';
					gameLoop();
				}
			}
			
			if (e.keyCode === 39) {
				gWorld.keyPressed.right = true;
			} else if (e.keyCode === 37){
				gWorld.keyPressed.left = true;
			}
			
	
		});
		
		window.addEventListener('keyup', function(e) {
			if (e.keyCode === 39) {
				gWorld.keyPressed.right = false;
			} else if (e.keyCode === 37){
				gWorld.keyPressed.left = false;
			}
		});
		//--------------------------------------------
		
		//INTRO AND INSTRUCTIONS----------------------------
		//the starting screen for game
		function mainScreen() {
			ctx.fillStyle = 'rgb(255,255,255)';
			ctx.font = "18px Helvetica, Ariel";

			ctx.fillText("Falling Bananas" ,30,30);
			
			ctx.fillText("Use the arrow keys to catch the bananas." ,30,60);
			
			ctx.fillText("Start" ,30,80);
			
			
		}
		//--------------------------------------------
		
		//INIT AND RUN GAME-----------------------------------
		function startGame() {
			//init the game
			gWorld.state = 'RUNNING';
			gWorld.addObject(makeGround(gWorld.w, gWorld.h));
			gWorld.addObject(makeCanopy(gWorld.w));
			gWorld.addObject(makeWalker(gWorld.w, gWorld.h));
			gWorld.addObject(makeWalker(gWorld.w, gWorld.h,true));
			gWorld.addObject(makePlayer());
			
			gameLoop();
		}
		//--------------------------------------------
		
		//ANIMATE AND UPDATE GAMELOOP----------------
		function gameLoop() {
			setTimeout(function() {

					loop = window.requestAnimationFrame(gameLoop);
					
					gWorld.updateGameObjects();
					gWorld.drawGame(ctx);
					gWorld.removeDeadObjects();
					gWorld.addNewObjects();
				
				if (gWorld.state === 'PAUSE') {
					window.cancelAnimationFrame(loop);
				}

			}, 1000 / fps);
		}
		//--------------------------------------------
		
		//LOAD THE MAIN SCREEN------------------------
		mainScreen();
		//--------------------------------------------
        });
    </script>
  </head>
  <body>    
    <style type="text/css">
		body {
			margin: 0 auto;
			text-align: center;
		}
      canvas {
        border:1px solid black;
		background: #197329;
		margin: 30px auto;
      }
    </style>
    <canvas id="canvas" width="600" height="400"> 
      Your browser does not support the HTML5 Canvas feature. This game uses new HTML5 features and will only work on the latest versions of Firefox, Safari or Chrome (and maybe Internet Explorer 9).         
    </canvas>   
  </body>
</html>